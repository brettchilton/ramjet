name: ramjet

services:
  db:
    image: postgres:latest
    container_name: ramjet_postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - '5532:5432' # Host port 5532, Container port 5432
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - app-network

  adminer:
    image: adminer:latest
    container_name: ramjet_adminer
    restart: always
    ports:
      - '8185:8080' # Host port 8185, Container port 8080. Change if busy.
    depends_on:
      - db
    networks:
      - app-network

  backend:
    build: ./backend
    container_name: ramjet_backend
    restart: always
    ports:
      - '8100:8000' # Host port 8100, Container port 8000. Change if busy.
    environment:
      DB_HOST: db
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      DEBUG: ${DEBUG}
      LOG_LEVEL: ${LOG_LEVEL}
      DO_SPACES_BUCKET: ${DO_SPACES_BUCKET}
      DO_SPACES_KEY: ${DO_SPACES_KEY}
      DO_SPACES_SECRET: ${DO_SPACES_SECRET}
      DO_SPACES_REGION: ${DO_SPACES_REGION}
      DO_SPACES_ENDPOINT: ${DO_SPACES_ENDPOINT}
      DO_SPACES_EXPIRATION_SECONDS: ${DO_SPACES_EXPIRATION_SECONDS}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      MAILGUN_API_KEY: ${MAILGUN_API_KEY}
      MAILGUN_DOMAIN: ${MAILGUN_DOMAIN}
      MAIL_FROM_EMAIL: ${MAIL_FROM_EMAIL}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME}
      FRONTEND_URL: ${FRONTEND_URL}
      SECRET_KEY: ${SECRET_KEY}
      VITE_USE_SIMPLE_AUTH: ${VITE_USE_SIMPLE_AUTH:-false}
      KRATOS_PUBLIC_URL: http://kratos:4533
      KRATOS_ADMIN_URL: http://kratos:4534
      KRATOS_WEBHOOK_SECRET: ${KRATOS_WEBHOOK_SECRET:-your-webhook-secret}
      GMAIL_CLIENT_ID: ${GMAIL_CLIENT_ID:-}
      GMAIL_CLIENT_SECRET: ${GMAIL_CLIENT_SECRET:-}
      GMAIL_REFRESH_TOKEN: ${GMAIL_REFRESH_TOKEN:-}
      GMAIL_POLL_INTERVAL_SECONDS: ${GMAIL_POLL_INTERVAL_SECONDS:-60}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-claude-sonnet-4-5-20250929}
    depends_on:
      - db
    volumes:
      - ./backend:/app # Mounts your local 'backend' folder to '/app' in the container for live code changes
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 5s
    networks:
      - app-network

  frontend:
    build: ./frontend
    container_name: ramjet_frontend
    restart: always
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - '5280:5179' # Maps host port 5280 to container port 5179
    environment:
      VITE_API_URL: ${VITE_API_URL}
    depends_on:
      - backend
    volumes:
      - ./frontend:/app # Mounts your local 'frontend' folder to '/app' for live code changes
      - /app/node_modules # Prevents host's node_modules from overwriting container's
    networks:
      - app-network

  kratos:
    image: oryd/kratos:v1.0.0
    container_name: ramjet_kratos
    restart: always
    ports:
      - "4533:4433" # Public port
      - "4534:4434" # Admin port
    environment:
      - DSN=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/kratos?sslmode=disable&max_conns=20&max_idle_conns=4
      - SECRETS_COOKIE=${KRATOS_COOKIE_SECRET}
      - SECRETS_CIPHER=${KRATOS_CIPHER_SECRET}
      - LOG_LEVEL=debug
      - LOG_LEAK_SENSITIVE_VALUES=true
      - SERVE_PUBLIC_BASE_URL=http://localhost:4533/
      - SERVE_ADMIN_BASE_URL=http://kratos:4434/
      - SELFSERVICE_DEFAULT_BROWSER_RETURN_URL=${FRONTEND_URL}/
      - SELFSERVICE_ALLOWED_RETURN_URLS=${FRONTEND_URL}
      - SELFSERVICE_FLOWS_ERROR_UI_URL=${FRONTEND_URL}/auth/error
      - SELFSERVICE_FLOWS_SETTINGS_UI_URL=${FRONTEND_URL}/settings
      - SELFSERVICE_FLOWS_RECOVERY_UI_URL=${FRONTEND_URL}/auth/recovery
      - SELFSERVICE_FLOWS_VERIFICATION_UI_URL=${FRONTEND_URL}/auth/verification
      - SELFSERVICE_FLOWS_LOGOUT_AFTER_DEFAULT_BROWSER_RETURN_URL=${FRONTEND_URL}/
      - SELFSERVICE_FLOWS_LOGIN_UI_URL=${FRONTEND_URL}/auth/login
      - SELFSERVICE_FLOWS_REGISTRATION_UI_URL=${FRONTEND_URL}/auth/registration
      - KRATOS_WEBHOOK_SECRET=${KRATOS_WEBHOOK_SECRET}
    command: serve all --dev --config /etc/config/kratos/kratos.yml
    volumes:
      - ./kratos:/etc/config/kratos
    depends_on:
      - db
      - kratos-migrate
    networks:
      - app-network

  kratos-migrate:
    image: oryd/kratos:v1.0.0
    container_name: ramjet_kratos_migrate
    environment:
      - DSN=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/kratos?sslmode=disable&max_conns=20&max_idle_conns=4
    volumes:
      - ./kratos:/etc/config/kratos
    command: -c /etc/config/kratos/kratos.yml migrate sql -e --yes
    depends_on:
      - db
    networks:
      - app-network
    restart: on-failure

  # ====================
  # MCP Server Services
  # ====================

  excel-mcp:
    build:
      context: ./mcp-servers/excel
      dockerfile: Dockerfile
    container_name: ramjet_excel_mcp
    environment:
      - MODE=${MODE:-stdio}
    ports:
      - "${EXCEL_MCP_PORT:-9200}:9100"
    volumes:
      - ./mcp-servers/excel/excel_files:/app/excel_files
    networks:
      - mcp-network
    restart: unless-stopped
    stdin_open: true
    tty: true

volumes:
  pgdata:

networks:
  app-network:
    driver: bridge
  mcp-network:
    driver: bridge
